{% extends "apply/base.html" %}
{% load static %}
{% load i18n %}
{% block content %}

<div class="main-header">
    <div class="my-container">
        <img src="https://apply.diplomat.university/_nuxt/img/headerLogo2.0a6ac49.svg" alt="Diplomat University"
             class="logo">
    </div>
</div>
<div class="hero-section">
    <div class="my-container">
        <h1>{% trans "Application form" %}</h1>
    </div>
</div>
<div class="page-content-wrapper">
    <main class="container">
        <div class="form-container">
                    <div class="row">
                        <div class="col-md-8">
                              <div class="p-4 border-0 rounded-3">
                                <h5 class="text-uppercase text-primary fw-bold mb-3">üè¢ {% trans "Admissions are open at DIPLOMAT UNIVERSITY!" %}</h5>
                                <p>üéì <strong>{% trans "Diplomat University" %}</strong> {% trans "is an intellectual hub that prepares competitive professionals with modern knowledge and skills for the international arena!" %}</p>

                                <ul class="ps-3 mb-3">
                                    <li>{% trans "A team consisting of extraordinary and autonomous ambassadors, international political scientists, and foreign professors" %}</li>
                                    <li>{% trans "Educational programs meeting international standards" %}</li>
                                    <li>{% trans "Creative and free academic environment" %}</li>
                                    <li>{% trans "Career development center" %}</li>
                                    <li>{% trans "Diplomas recognized both in Uzbekistan and abroad" %}</li>
                                </ul>

                                <p><strong>üéì {% trans "12 Bachelor's and 4 Master's degree" %}</strong> {% trans "programs are waiting for you" %}</p>
                            </div>
                        </div>

                    <div class="col-md-4" style="padding-top:20px">

                    <form id="checkStatusForm">
                        {% csrf_token %}
                        <div class="status-check-container">
                            <p>{% trans "You can check your application status here. Type your application number below:" %}</p>
                            <input type="text" id="applicationNumber" name="application_number" placeholder="{% trans 'Your application number' %}" required>
                            <input type="submit" class="check-btn" value="{% trans 'Check' %}">
                            <div id="statusResult"></div>
                        </div>
                    </form>
                    </div>

                    </div>


            <div class="form-steps" >

                <div id="step-indicator-1" class="step completed">
                    <div class="step-content">
                        <div class="step-circle"><i class="fas fa-check"></i></div>
                        <div class="step-description">
                            <div class="step-label">{% trans "Step 1" %}</div>
                            <div class="step-title">{% trans "Filling out the form" %}</div>
                        </div>
                    </div>
                    <div class="step-line"></div>
                </div>
                <div id="step-indicator-2" class="step">
                    <div class="step-content">
                        <div class="step-circle">2</div>
                        <div class="step-description">
                            <div class="step-label">{% trans "Step 2" %}</div>
                            <div class="step-title">{% trans "Uploading documents" %}</div>
                        </div>
                    </div>
                    <div class="step-line"></div>
                </div>
                <div id="step-indicator-3" class="step">
                    <div class="step-content">
                        <div class="step-circle">3</div>
                        <div class="step-description">
                            <div class="step-label">{% trans "Step 3" %}</div>
                            <div class="step-title">{% trans "Verifying and submitting" %}</div>
                        </div>
                    </div>
                    <div class="step-line"></div>
                </div>
                <div id="step-indicator-4" class="step">
                    <div class="step-content">
                        <div class="step-circle"><i class="fas fa-flag-checkered"></i></div>
                        <div class="step-description">
                            <div class="step-label">{% trans "Step 4" %}</div>
                            <div class="step-title">{% trans "Test" %}</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-and-status">

                <form id="applicationForm" class="application-form" novalidate action="{% url 'application_form' %}">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="degree">{% trans "Degree" %}<span class="text-danger">*</span></label>
                                <select id="degree" name="degree" required>
                                    <option value="">---------</option>
                                    {% for i in degrees %}
                                    <option value="{{i.id}}">{{i.name}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            </div> <div class="col-md-6">
                            <div class="form-group">
                                <label for="education-direction">{% trans "Direction of education" %}<span
                                        class="text-danger">*</span></label>
                                <select id="education-direction" name="education_direction" disabled required>
                                    <option value="">---------</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="study-form">{% trans "Form of study" %}<span class="text-danger">*</span></label>
                                <select id="study-form" name="study_form" disabled required>
                                    <option value="">---------</option>

                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="language">{% trans "Language of the test" %}<span class="text-danger">*</span></label>
                                <select id="language" name="language"  required>
                                    <option value="" disabled selected>---------</option>
                                    <option value="uzbek">{% trans "Uzbek" %}</option>
                                    <option value="russian">{% trans "Russian" %}</option>

                                </select>
                            </div>
                        </div>


                    </div>
                    <hr style="height:2px; background:black">

                    <div id="step-1">

                        <h3>{% trans "Personal particulars:" %}</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="surname">{% trans "Surname" %}<span class="text-danger">*</span></label>
                                <input type="text" id="surname" name="surname" placeholder="{% trans 'Surname' %}" required>
                            </div>
                            <div class="form-group">
                                <label for="first_name">{% trans "First name" %}<span class="text-danger">*</span></label>
                                <input type="text" id="first_name" name="first_name" placeholder="{% trans 'First name' %}" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="middle_name">{% trans "Middle name" %}</label>
                                <input type="text" id="middle_name" name="middle_name" placeholder="{% trans 'Middle name' %}">
                            </div>
                            <div class="form-group">
                                <label for="gender">{% trans "Gender" %}<span class="text-danger">*</span></label>
                                <select id="gender" name="gender" required>
                                    <option value="" disabled selected>---------</option>
                                    <option value="male">{% trans "Male" %}</option>
                                    <option value="female">{% trans "Female" %}</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="phone">{% trans "Phone number" %}<span class="text-danger">*</span></label>
                                <input type="tel" id="phone" name="phone" placeholder="+998901234567"
                                       pattern="\+998[0-9]{9}"
                                       title="{% trans 'Enter the number in +998901234567 format' %}" required>
                            </div>
                            <div class="form-group">
                                <label for="telegram">{% trans "Phone number (Telegram)" %}</label>
                                <input type="text" id="telegram" name="telegram"
                                       placeholder="{% trans 'Telegram username or phone number' %}">
                            </div>
                        </div>
                        <h3>{% trans "Passport details:" %}</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="passport">{% trans "Passport No.:" %}<span class="text-danger">*</span></label>
                                <input type="text" id="passport" name="passport" placeholder="AA1234567"
                                       pattern="[A-Z]{2}[0-9]{7}"
                                       maxlength="9"
                                       title="{% trans 'Enter the passport series in AA1234567 format' %}" required>
                                <div class="invalid-feedback" id="passport-error"></div>
                            </div>
                            <div class="form-group">
                                <label for="jshir">{% trans "JSHSHIR (PINFL)" %}<span class="text-danger">*</span>
                                    <i class="fas fa-info-circle info-icon" data-bs-toggle="modal"
                                       data-bs-target="#jshirModal"></i>
                                </label>
                                <input type="tel" id="jshir" name="jshir" placeholder="{% trans '14-digit number' %}"
                                       inputmode="numeric"
                                       pattern="[0-9]{14}"
                                       maxlength="14"
                                       title="{% trans 'JSHSHIR must consist of 14 digits' %}" required>
                                <div class="invalid-feedback" id="jshir-error"></div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="address_of_permanent_residence">{% trans "Address of permanent residence" %}<span
                                        class="text-danger">*</span></label>
                                <input type="text" id="address_of_permanent_residence"
                                       name="address_of_permanent_residence"
                                       placeholder="{% trans 'Address of permanent residence' %}" required>
                            </div>
                            <div class="form-group">
                                <label for="region">{% trans "Region" %}<span class="text-danger">*</span></label>
                                <select id="region" name="region" required>
                                    <option value="" disabled selected></option>
                                    {% for region in regions %}
                                    <option value="{{ region.id }}">{{ region.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="next-btn" onclick="goToStep(2)">{% trans "Next" %}</button>
                        </div>
                    </div>
                    <div id="step-2" style="display: none;">
                        <h3>{% trans "I am attaching the following documents to this application:" %}</h3>
                        <p><span class="text-danger">*</span> {% trans "Fields marked with * are required." %}</p>

                        <div class="form-group">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="photo-upload">{% trans "Photo (3x4)" %}<span class="text-danger">*</span></label>
                                    <input type="file" id="photo-upload" name="photo" class="form-control" required
                                           accept="image/*">
                                </div>
                                <div class="col-md-6">
                                    <label><b>{% trans "Requirements" %}</b></label>
                                    <label>{% trans "3x4, on a white background ‚Äì jpeg, png format" %}</label>
                                    <label>{% trans "The maximum file size is up to 3 MB" %}</label>
                                </div>
                            </div>
                        </div>
                        <hr style="height:2px; color:black">
                        <div class="form-group">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="passport-copy-upload">{% trans "Passport copy" %}<span class="text-danger">*</span></label>
                                    <input type="file" id="passport-copy-upload" name="passport_copy"
                                           class="form-control" required accept=".pdf,.jpg,.jpeg,.png">
                                </div>
                                <div class="col-md-6">
                                    <label><b>{% trans "Requirements" %}</b></label>
                                    <label>{% trans "Passport copy including the residence registration ‚Äì jpeg/pdf format." %}</label>
                                    <label>{% trans "The maximum file size is up to 3 MB" %}</label>
                                </div>
                            </div>
                        </div>
                        <hr style="height:2px; color:black">
                        <div class="form-group">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="diploma-upload">{% trans "Diploma" %}<span
                                            class="text-danger">*</span></label>
                                    <input type="file" id="diploma-upload" name="diploma" class="form-control" required
                                           accept=".pdf,.jpg,.jpeg,.png">
                                </div>
                                <div class="col-md-6">
                                    <label><b>{% trans "Requirements" %}</b></label>
                                    <label>{% trans "The copy of the document of secondary or secondary specialized education (or a certificate confirming graduation in the current year)" %}</label>
                                    <label>{% trans "The maximum file size is up to 3 MB" %}</label>
                                </div>
                            </div>
                        </div>
                        <hr style="height:2px; color:black">
                        <!-- DTM Section with Toggle -->
<div class="form-group">
    <div class="row">
        <div class="col-md-6">
            <div class="form-check mb-3">
                <input type="checkbox" id="has-dtm" name="has_dtm" class="form-check-input">
                <label class="form-check-label" for="has-dtm">
                    {% trans "I have DTM results to submit" %}
                </label>
            </div>

            <div class="form-group" id="dtm-fields" style="display: none;">
                <div class="row">
                    <div class="col-md-12">
                        <label>{% trans "Applicants 'documents with scores of at least 56.7 and above are accepted from the entrance exams." %}</label>
                        <label>{% trans "Only in the 2022-2023 academic year and 2023-2024 academic year will the results of exams passed to state Higher Education Institutions be recognized." %}</label>
                        <label for="dtm-ball-input">{% trans "Your score" %}</label>
                        <input type="number" step="any" id="dtm-ball-input" name="dtm_ball"
                               class="form-control" placeholder="{% trans 'Your score' %}">
                        <label for="dtm-file-upload">{% trans "DTM account" %}</label>
                        <input type="file" id="dtm-file-upload" name="dtm_file" class="form-control"
                               accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div id="dtm-requirements" style="display: none;">
                <label><b>{% trans "Requirements" %}</b></label>
                <label>{% trans "Applicant permission (QR code required to be loaded to be clearly visible)" %}</label>
                <label>{% trans "The maximum file size is up to 3 MB" %}</label>
            </div>
        </div>
    </div>
</div>
<hr style="height:2px; color:black">

<!-- Additional Documents Section with Toggle -->
<div class="form-group">
    <div class="row">
        <div class="col-md-6">
            <div class="form-check mb-3">
                <input type="checkbox" id="has-additional-docs" name="has_additional_docs" class="form-check-input">
                <label class="form-check-label" for="has-additional-docs">
                    {% trans "I have additional documents to submit" %}
                </label>
            </div>

            <div class="form-group" id="additional-docs-fields" style="display: none;">
                <div class="row">
                    <div class="col-md-12">
                        <label for="additional-docs-upload">{% trans "Additional documents" %}</label>
                        <input type="file" id="additional-docs-upload" name="additional_documents"
                               class="form-control" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div id="additional-docs-requirements" style="display: none;">
                <label><b>{% trans "Requirements" %}</b></label>
                <label>{% trans "Certificates (IELTS, various competitions etc.)" %}</label>
                <label>{% trans "The maximum file size is up to 3 MB" %}</label>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // DTM Toggle
    $('#has-dtm').change(function() {
        if(this.checked) {
            $('#dtm-fields').show();
            $('#dtm-requirements').show();
            $('#dtm-ball-input, #dtm-file-upload').prop('required', true);
        } else {
            $('#dtm-fields').hide();
            $('#dtm-requirements').hide();
            $('#dtm-ball-input, #dtm-file-upload').prop('required', false);
            $('#dtm-ball-input').val('');
            $('#dtm-file-upload').val('');
        }
    });

    // Additional Documents Toggle
    $('#has-additional-docs').change(function() {
        if(this.checked) {
            $('#additional-docs-fields').show();
            $('#additional-docs-requirements').show();
            $('#additional-docs-upload').prop('required', true);
        } else {
            $('#additional-docs-fields').hide();
            $('#additional-docs-requirements').hide();
            $('#additional-docs-upload').prop('required', false);
            $('#additional-docs-upload').val('');
        }
    });

    // Load saved state if exists
    if(localStorage.getItem('applicationFormData')) {
        const formData = JSON.parse(localStorage.getItem('applicationFormData'));
        if(formData.has_dtm) {
            $('#has-dtm').prop('checked', true).trigger('change');
        }
        if(formData.has_additional_docs) {
            $('#has-additional-docs').prop('checked', true).trigger('change');
        }
    }
});
</script>

                        <div class="form-actions">
                            <button type="button" class="next-btn" onclick="goToStep(3)">{% trans "Next" %}</button>
                        </div>
                    </div>
                    <div id="step-3" style="display: none;">
                        <h3>{% trans "Verify and Submit" %}</h3>
                        <p id="confirmation-name-paragraph"></p>
                        <p>{% trans "I take responsibility for the accuracy of the data in my application and confirm the information signed by me." %}</p>
                        <p>{% trans "I will enroll in the DIPLOMAT UNIVERSITY (hereinafter referred to as the University) on the direction/course specified in this application." %}</p>
                        <p>{% trans "Informed about the cost of studying at the University." %}</p>
                        <p>{% trans "I undertake to comply with the internal rules of the University." %}</p>
                        <p>{% trans "I undertake to respect the administration and the scholars of the University." %}</p>
                        <p>{% trans "I agree that violation of the rules of the University or disrespect for the administration, as well as for the scholars of the University may cause rejection in the execution of my application or termination of the training contract." %}</p>
                        <p>{% trans "I will take the opportunity to register only once in the University system." %}</p>
                        <p>{% trans "I agree and take note that the provision of incorrect information in the application or a falsified document will be the reason for the rejection of my application." %}</p>
                        <p>{% trans "I agree and confirm the possibility of my expulsion from the number of University students if during the verification of my documents false data / falsified information is revealed." %}</p>
                        <p>{% trans "In the above-mentioned case, I confirm and agree that the University will not refund the contract amount paid by me in full, on account of material compensation." %}</p>

                        <input type="checkbox" id="confirm-checkbox"> <label for="confirm-checkbox">{% trans "Confirm" %}</label>

                        <div id="review-data">
                        </div>

                        <div class="form-actions">
                            <button type="submit" id="submit-btn" class="submit-btn" disabled>{% trans "Submit" %}</button>
                        </div>
                    </div>

                    <div id="step-4" style="display: none; text-align: center;">
                        <i class="fas fa-check-circle" style="font-size: 80px; color: green; margin-bottom: 20px;"></i>
                        <h2>{% trans "Your application has been successfully submitted!" %}</h2>
                        <p>{% trans "Your application number:" %} <strong id="application-number"></strong>.</p>
                        <p>{% trans "Please keep this number in mind to check your application status in the future." %}</p>

                        <p style="margin-top: 20px;">{% trans "We will contact you soon." %}</p>
                        <div id="test-link-placeholder"></div>


                    </div>

                </form>
            </div>
        </div>
    </main>
</div>

<div class="modal fade" id="jshirModal" tabindex="-1" aria-labelledby="jshirModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="jshirModalLabel">{% trans "What is JSHSHIR (PINFL)?" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img src="https://cisc.uz/uz/media/images/470186658_2527042054173012_8502034666669134116_n.jpg"
                     class="img-fluid" alt="{% trans 'Sample JSHSHIR' %}">
            </div>
        </div>
    </div>
</div>
    <script>
    // ===================================================================================
    // ASYNCHRONOUS FUNCTIONS: Loading related menu data
    // ===================================================================================

    /**
     * Load education directions based on selected degree
     * @param {string} degreeId - Selected degree ID
     */
    function loadDirections(degreeId) {
        const $directionSelect = $('#education-direction');
        const $studyFormSelect = $('#study-form');

        // Reset direction and study form selects
        $directionSelect.html('<option value="">{% trans "Loading..." %}</option>').prop('disabled', true);
        $studyFormSelect.html('<option value="">{% trans "Choose a direction first." %}</option>').prop('disabled', true);

        if (!degreeId) {
            $directionSelect.html('<option value="">{% trans "First select the level" %}</option>');
            return;
        }

        $.ajax({
            url: `/ajax/get-directions/${degreeId}/`,
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                let options = '<option value="">---------</option>';
                $.each(data, function(index, direction) {
                    options += `<option value="${direction.id}">${direction.name}</option>`;
                });
                $directionSelect.html(options).prop('disabled', false);
            },
            error: function(xhr, status, error) {
                console.error('{% trans "Error loading training courses:" %}', error);
                $directionSelect.html('<option value="">{% trans "An error occurred." %}</option>');
            }
        });
    }

    /**
     * Load study forms based on selected direction
     * @param {string} directionId - Selected direction ID
     */
    function loadStudyForms(directionId) {
        const $studyFormSelect = $('#study-form');
        $studyFormSelect.html('<option value="">{% trans "Loading..." %}</option>').prop('disabled', true);

        if (!directionId) {
            $studyFormSelect.html('<option value="">{% trans "Choose a direction first." %}</option>');
            return;
        }

        $.ajax({
            url: `/ajax/get-study-forms/${directionId}/`,
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                let options = '<option value="">---------</option>';
                if (data.length > 0) {
                    $.each(data, function(index, form) {
                        options += `<option value="${form.id}">${form.name}</option>`;
                    });
                    $studyFormSelect.html(options).prop('disabled', false);
                } else {
                    $studyFormSelect.html('<option value="">{% trans "No form of education available" %}</option>').prop('disabled', true);
                }
            },
            error: function(xhr, status, error) {
                console.error('{% trans "Error loading educational forms:" %}', error);
                $studyFormSelect.html('<option value="">{% trans "An error occurred." %}</option>');
            }
        });
    }

    function saveFormState() {
        const formData = {};

        $('#applicationForm').find(':input').each(function() {
            const $input = $(this);
            if ($input.attr('name') && $input.attr('type') !== 'submit' && $input.attr('type') !== 'button') {
                if ($input.attr('type') === 'file') {
                    if ($input[0].files.length > 0) {
                        formData[$input.attr('name')] = { filename: $input[0].files[0].name };
                    }
                } else if ($input.attr('type') === 'radio') {
                    if ($input.is(':checked')) {
                        formData[$input.attr('name')] = $input.val();
                    }
                } else {
                    formData[$input.attr('name')] = $input.val();
                }
            }
        });

        localStorage.setItem('applicationFormData', JSON.stringify(formData));
    }

    /**
     * Load saved form data from localStorage
     */
    async function loadFormState() {
        const savedDataJSON = localStorage.getItem('applicationFormData');
        if (!savedDataJSON) return;

        const data = JSON.parse(savedDataJSON);
        const $form = $('#applicationForm');

        // Fill regular fields
        for (const name in data) {
            const $element = $form.find(`[name="${name}"]`);
            if ($element.length === 0) continue;

            // Skip dependent fields for now
            const dependentFields = ['degree', 'education_direction', 'study_form'];
            if (dependentFields.includes(name)) continue;

            if ($element.attr('type') === 'file') {
                const filename = data[name]?.filename;
                if (filename) {
                    let $fileInfo = $element.siblings('.file-info');
                    if ($fileInfo.length === 0) {
                        $fileInfo = $('<span>', {
                            class: 'file-info text-muted small d-block'
                        }).insertAfter($element);
                    }
                    $fileInfo.html(`{% trans "Last selected file:" %} <strong>${filename}</strong>. <br>{% trans "For security reasons, you must reselect the file." %}`);
                }
            } else if ($element.attr('type') === 'radio') {
                $element.filter(`[value="${data[name]}"]`).prop('checked', true);
            } else {
                $element.val(data[name]);
            }
        }

        // Load dependent selects in correct sequence
        if (data.degree) {
            $form.find('[name="degree"]').val(data.degree);
            await loadDirections(data.degree);
        }
        if (data.education_direction) {
            $form.find('[name="education_direction"]').val(data.education_direction);
            await loadStudyForms(data.education_direction);
        }
        if (data.study_form) {
            $form.find('[name="study_form"]').val(data.study_form);
        }
        console.log('{% trans "The data was successfully reloaded." %}');
    }

    // ===================================================================================
    // VALIDATION HELPER FUNCTIONS
    // ===================================================================================

    /**
     * Display validation error under specified field
     * @param {string} fieldId - Input field ID
     * @param {string} message - Error message to display
     */
    function displayValidationError(fieldId, message) {
        $(`#${fieldId}`).addClass('is-invalid');
        const $errorElement = $(`#${fieldId}-error`);
        if ($errorElement.length) {
            $errorElement.text(message).show();
        }
    }

    /**
     * Clear all validation errors in the form
     */
    function clearValidationErrors() {
        $('.invalid-feedback').text('').hide();
        $('.is-invalid').removeClass('is-invalid');
    }

    /**
     * Check uniqueness of passport and JSHIR with backend
     * @returns {Promise<boolean>} - Returns true if unique, false otherwise
     */
    function checkUniqueness() {
        clearValidationErrors();

        const passportInput = $('#passport').val();
        const jshirInput = $('#jshir').val();
        const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

        return $.ajax({
            url: '/api/check-uniqueness/',
            type: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            data: JSON.stringify({
                passport: passportInput,
                jshir: jshirInput
            }),
            contentType: 'application/json',
            dataType: 'json'
        }).then(function(data) {
            if (data.is_unique) {
                return true;
            } else {
                if (data.errors.passport) {
                    displayValidationError('passport', data.errors.passport);
                }
                if (data.errors.jshir) {
                    displayValidationError('jshir', data.errors.jshir);
                }
                return false;
            }
        }).fail(function(xhr, status, error) {
            console.error('{% trans "Error checking uniqueness:" %}', error);
            alert('{% trans "An error occurred while connecting to the server." %}');
            return false;
        });
    }

    // ===================================================================================
    // STEP-BY-STEP FORM (WIZARD) LOGIC
    // ===================================================================================

    let currentStep = 1;

    /**
     * Navigate between steps with validation
     * @param {number} step - Target step number
     */
    async function goToStep(step) {
        // Validate before proceeding to next step
        if (step > currentStep) {
            const $currentStepContainer = $(`#step-${currentStep}`);
            const $inputs = $currentStepContainer.find('input[required], select[required]');

            let isBrowserValid = true;
            $inputs.each(function() {
                if (!this.checkValidity()) {
                    isBrowserValid = false;
                    $(this).addClass('is-invalid');
                } else {
                    $(this).removeClass('is-invalid');
                }
            });

            if (!isBrowserValid) return;

            // Check uniqueness when moving from step 1 to 2
            if (currentStep === 1 && step === 2) {
                const isUnique = await checkUniqueness();
                if (!isUnique) return;
            }
        }

        // Hide all steps
        $('[id^="step-"]').hide();
        clearValidationErrors();

        // Show relevant step(s)
        if (step === 3) {
            // Validate step 2 before showing step 3
            const $step2Container = $('#step-2');
            const $inputsStep2 = $step2Container.find('input[required], select[required]');
            let isStep2Valid = true;

            $inputsStep2.each(function() {
                if (!this.checkValidity()) {
                    isStep2Valid = false;
                    return false; // break loop
                }
            });

            if (!isStep2Valid) {
                $('#step-2').show();
                updateStepIndicator(2);
                currentStep = 2;
                return;
            }

            // Show steps 1-3 for confirmation
            $('#step-1, #step-2, #step-3').show();
            $('#step-1 .form-actions, #step-2 .form-actions').hide();

            const surname = $('#surname').val().trim();
            const firstName = $('#first_name').val().trim();
            $('#confirmation-name-paragraph').text(`I, ${surname} ${firstName},`);
        } else {
            $(`#step-${step}`).show();
        }
        if (step === 4) {
        const appNumber = $('#application-number').text().trim();
        if (appNumber) {
            const fileContent = `{% trans "Your application number to Diplomat University:" %} ${appNumber}`;
            const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `${appNumber}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    }

        updateStepIndicator(step);
        currentStep = step;
    }

    /**
     * Update the step indicator at the top
     * @param {number} activeStep - Current active step number
     */
    function updateStepIndicator(activeStep) {
        for (let i = 1; i <= 4; i++) {
            const $indicator = $(`#step-indicator-${i}`);
            if ($indicator.length === 0) continue;

            const $circle = $indicator.find('.step-circle');
            $indicator.removeClass('completed active');

            if (i < activeStep) {
                $indicator.addClass('completed');
                $circle.html('<i class="fas fa-check"></i>');
            } else if (i === activeStep) {
                $indicator.addClass('active');
                $circle.html(i === 4 ? '<i class="fas fa-flag-checkered"></i>' : i);
            } else {
                $circle.html(i === 4 ? '<i class="fas fa-flag-checkered"></i>' : i);
            }
        }
    }

    // ===================================================================================
    // FILE DOWNLOAD FUNCTION
    // ===================================================================================

    /**
     * Download application number as text file
     */
    function downloadApplicationNumber() {
        const appNumber = $('#application-number').text();

        if (!appNumber) {
            alert('{% trans "Application not found!" %}');
            return;
        }

        const fileContent = `{% trans "Your application number to Diplomat University:" %} ${appNumber}`;
        const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);

        const $link = $('<a>', {
            href: url,
            download: `${appNumber}.txt`
        }).hide().appendTo('body');

        $link[0].click();
        setTimeout(function() {
            $link.remove();
            URL.revokeObjectURL(url);
        }, 100);
    }

    // ===================================================================================
    // DOCUMENT READY HANDLER
    // ===================================================================================

    $(document).ready(function() {
        // Load saved form data
        loadFormState();

        const $form = $('#applicationForm');
        const $submitBtn = $('#submit-btn');

        // Save form state on input changes
        $form.on('input', saveFormState);

        // Related select event listeners
        $('#degree').on('change', function() {
            loadDirections(this.value);
        });

        $('#education-direction').on('change', function() {
            loadStudyForms(this.value);
        });

        // JSHIR input - numbers only
        $('#jshir').on('input', function() {
            $(this).val($(this).val().replace(/[^0-9]/g, ''));
        });

        // Confirmation checkbox logic
        $('#confirm-checkbox').on('change', function() {
            $submitBtn.prop('disabled', !this.checked);
        });

        // Form submission
        $form.on('submit', function(event) {
            event.preventDefault();

            if (!$('#confirm-checkbox').is(':checked')) {
                alert('{% trans "Please confirm the application." %}');
                return;
            }

            const formData = new FormData(this);
            $submitBtn.prop('disabled', true).text('{% trans "Sending..." %}');

            $.ajax({
                url: $form.attr('action') || window.location.pathname,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
                },
                success: function(result) {
                    if (result.success) {
                        $('#application-number').text(result.application_number);
                        $('#test-link-placeholder').html(`<a href="/du-test/${result.application_number}/" class="next-btn">{% trans "START TEST" %}</a>`);
                        goToStep(4);
                        localStorage.removeItem('applicationFormData');
                    } else {
                        alert('{% trans "There was an error submitting the application. Please check the fields." %}');
                        console.error('Server errors:', result.errors);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Submit error:', error);
                    alert('{% trans "An unexpected error occurred while submitting the application." %}');
                },
                complete: function() {
                    $submitBtn.prop('disabled', false).text('SUBMIT');
                }
            });
        });

        // Save application number button
        $('#save-app-number-btn').on('click', downloadApplicationNumber);

        // Initialize step indicator
        updateStepIndicator(1);
    });
    </script>
<script>
$(document).ready(function() {
    $('#checkStatusForm').submit(function(e) {
        e.preventDefault();

        // Clear previous results
        $('#statusResult').empty();

        const appNumber = $('#applicationNumber').val().trim();
        if (!appNumber) {
            $('#statusResult').html('<div class="alert alert-danger">{% trans "Application number" %}</div>');
            return;
        }

        // Show loading state
        $.ajax({
            url: '{% url "check_application_status" %}',
            type: 'POST',
            data: {
                'application_number': appNumber,
                'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
            },
            success: function(response) {
    if (response.success) {
        const statusClass = 'status-' + response.status.toLowerCase();
        const statusDisplay = response.status_display;

        let resultHtml = `
            <div class="${statusClass}">
                <strong>{% trans "Status" %}:</strong> ${statusDisplay}
            </div>
        `;

        // Faqat test_status true bo‚Äòlsa va application_number mavjud bo‚Äòlsa
        if ((response.test_status === true || response.test_status === 'true') && response.application_number) {
            resultHtml += `
                <div style="margin-top: 10px;">
                    <a href="/du-test/${response.application_number}/" class="btn btn-success">
                        {% trans "START TEST" %}
                    </a>
                </div>
            `;
        }

        $('#statusResult').html(resultHtml);
    } else {
        $('#statusResult').html(`<div class="alert alert-danger">${response.error}</div>`);
    }
},

            error: function(xhr) {
                let errorMsg = "{% trans 'Server error. Please try again later.' %}";
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                }
                $('#statusResult').html(`<div class="alert alert-danger">${errorMsg}</div>`);
            },
            complete: function() {
                $('.check-btn').prop('disabled', false).val('{% trans "Check" %}');
            }
        });
    });
});
</script>
{% endblock content %}