{% load static %}
{% load i18n %}

<html lang="{{ request.LANGUAGE_CODE }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans "Application Form" %} - Diplomat University</title>
    <link rel="stylesheet" href="{% static 'apply/css/style.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <header>
        <div class="my-container header-content">
            <div class="contact-info">
                <i class="fas fa-phone-alt"></i> +998 88 128 88 88
                <i class="fas fa-phone-alt"></i> +998 88 124 88 88
            </div>
            <div class="dropdown lang-switcher">
                <button class="btn dropdown-toggle" type="button" id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="color:white">
                    {% get_current_language as LANGUAGE_CODE %}
                    {{ LANGUAGE_CODE|upper }}
                </button>
                <ul class="dropdown-menu" aria-labelledby="languageDropdown">
                    {% get_available_languages as LANGUAGES %}
                    {% for lang_code, lang_name in LANGUAGES %}
                        <li><a class="dropdown-item" href="{% url 'set_language' lang_code %}">{{ lang_name }}</a></li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </header>

    {% block content %}
    {% endblock content %}

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <span>{% trans "Copyright" %} Â© Diplomat University 2022. {% trans "All rights reserved" %}.</span>
                <span>{% trans "Developed by:" %} <a href="https://diplomat.university/" target="_blank">DIPLOMAT UNIVERSITY</a></span>
            </div>
        </div>
    </footer>

    <script>
    // ===================================================================================
    // ASYNCHRONOUS FUNCTIONS: Loading related menu data
    // ===================================================================================

    /**
     * Load education directions based on selected degree
     * @param {string} degreeId - Selected degree ID
     */
    function loadDirections(degreeId) {
        const $directionSelect = $('#education-direction');
        const $studyFormSelect = $('#study-form');

        // Reset direction and study form selects
        $directionSelect.html('<option value="">{% trans "Loading..." %}</option>').prop('disabled', true);
        $studyFormSelect.html('<option value="">{% trans "Choose a direction first." %}</option>').prop('disabled', true);

        if (!degreeId) {
            $directionSelect.html('<option value="">{% trans "First select the level" %}</option>');
            return;
        }

        $.ajax({
            url: `/ajax/get-directions/${degreeId}/`,
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                let options = '<option value="">---------</option>';
                $.each(data, function(index, direction) {
                    options += `<option value="${direction.id}">${direction.name}</option>`;
                });
                $directionSelect.html(options).prop('disabled', false);
            },
            error: function(xhr, status, error) {
                console.error('{% trans "Error loading training courses:" %}', error);
                $directionSelect.html('<option value="">{% trans "An error occurred." %}</option>');
            }
        });
    }

    /**
     * Load study forms based on selected direction
     * @param {string} directionId - Selected direction ID
     */
    function loadStudyForms(directionId) {
        const $studyFormSelect = $('#study-form');
        $studyFormSelect.html('<option value="">{% trans "Loading..." %}</option>').prop('disabled', true);

        if (!directionId) {
            $studyFormSelect.html('<option value="">{% trans "Choose a direction first." %}</option>');
            return;
        }

        $.ajax({
            url: `/ajax/get-study-forms/${directionId}/`,
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                let options = '<option value="">---------</option>';
                if (data.length > 0) {
                    $.each(data, function(index, form) {
                        options += `<option value="${form.id}">${form.name}</option>`;
                    });
                    $studyFormSelect.html(options).prop('disabled', false);
                } else {
                    $studyFormSelect.html('<option value="">{% trans "No form of education available" %}</option>').prop('disabled', true);
                }
            },
            error: function(xhr, status, error) {
                console.error('{% trans "Error loading educational forms:" %}', error);
                $studyFormSelect.html('<option value="">{% trans "An error occurred." %}</option>');
            }
        });
    }

    function saveFormState() {
        const formData = {};

        $('#applicationForm').find(':input').each(function() {
            const $input = $(this);
            if ($input.attr('name') && $input.attr('type') !== 'submit' && $input.attr('type') !== 'button') {
                if ($input.attr('type') === 'file') {
                    if ($input[0].files.length > 0) {
                        formData[$input.attr('name')] = { filename: $input[0].files[0].name };
                    }
                } else if ($input.attr('type') === 'radio') {
                    if ($input.is(':checked')) {
                        formData[$input.attr('name')] = $input.val();
                    }
                } else {
                    formData[$input.attr('name')] = $input.val();
                }
            }
        });

        localStorage.setItem('applicationFormData', JSON.stringify(formData));
    }

    /**
     * Load saved form data from localStorage
     */
    async function loadFormState() {
        const savedDataJSON = localStorage.getItem('applicationFormData');
        if (!savedDataJSON) return;

        const data = JSON.parse(savedDataJSON);
        const $form = $('#applicationForm');

        // Fill regular fields
        for (const name in data) {
            const $element = $form.find(`[name="${name}"]`);
            if ($element.length === 0) continue;

            // Skip dependent fields for now
            const dependentFields = ['degree', 'education_direction', 'study_form'];
            if (dependentFields.includes(name)) continue;

            if ($element.attr('type') === 'file') {
                const filename = data[name]?.filename;
                if (filename) {
                    let $fileInfo = $element.siblings('.file-info');
                    if ($fileInfo.length === 0) {
                        $fileInfo = $('<span>', {
                            class: 'file-info text-muted small d-block'
                        }).insertAfter($element);
                    }
                    $fileInfo.html(`{% trans "Last selected file:" %} <strong>${filename}</strong>. <br>{% trans "For security reasons, you must reselect the file." %}`);
                }
            } else if ($element.attr('type') === 'radio') {
                $element.filter(`[value="${data[name]}"]`).prop('checked', true);
            } else {
                $element.val(data[name]);
            }
        }

        // Load dependent selects in correct sequence
        if (data.degree) {
            $form.find('[name="degree"]').val(data.degree);
            await loadDirections(data.degree);
        }
        if (data.education_direction) {
            $form.find('[name="education_direction"]').val(data.education_direction);
            await loadStudyForms(data.education_direction);
        }
        if (data.study_form) {
            $form.find('[name="study_form"]').val(data.study_form);
        }
        console.log('{% trans "The data was successfully reloaded." %}');
    }

    // ===================================================================================
    // VALIDATION HELPER FUNCTIONS
    // ===================================================================================

    /**
     * Display validation error under specified field
     * @param {string} fieldId - Input field ID
     * @param {string} message - Error message to display
     */
    function displayValidationError(fieldId, message) {
        $(`#${fieldId}`).addClass('is-invalid');
        const $errorElement = $(`#${fieldId}-error`);
        if ($errorElement.length) {
            $errorElement.text(message).show();
        }
    }

    /**
     * Clear all validation errors in the form
     */
    function clearValidationErrors() {
        $('.invalid-feedback').text('').hide();
        $('.is-invalid').removeClass('is-invalid');
    }

    /**
     * Check uniqueness of passport and JSHIR with backend
     * @returns {Promise<boolean>} - Returns true if unique, false otherwise
     */
    function checkUniqueness() {
        clearValidationErrors();

        const passportInput = $('#passport').val();
        const jshirInput = $('#jshir').val();
        const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

        return $.ajax({
            url: '/api/check-uniqueness/',
            type: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            data: JSON.stringify({
                passport: passportInput,
                jshir: jshirInput
            }),
            contentType: 'application/json',
            dataType: 'json'
        }).then(function(data) {
            if (data.is_unique) {
                return true;
            } else {
                if (data.errors.passport) {
                    displayValidationError('passport', data.errors.passport);
                }
                if (data.errors.jshir) {
                    displayValidationError('jshir', data.errors.jshir);
                }
                return false;
            }
        }).fail(function(xhr, status, error) {
            console.error('{% trans "Error checking uniqueness:" %}', error);
            alert('{% trans "An error occurred while connecting to the server." %}');
            return false;
        });
    }

    // ===================================================================================
    // STEP-BY-STEP FORM (WIZARD) LOGIC
    // ===================================================================================

    let currentStep = 1;

    /**
     * Navigate between steps with validation
     * @param {number} step - Target step number
     */
    async function goToStep(step) {
        // Validate before proceeding to next step
        if (step > currentStep) {
            const $currentStepContainer = $(`#step-${currentStep}`);
            const $inputs = $currentStepContainer.find('input[required], select[required]');

            let isBrowserValid = true;
            $inputs.each(function() {
                if (!this.checkValidity()) {
                    isBrowserValid = false;
                    $(this).addClass('is-invalid');
                } else {
                    $(this).removeClass('is-invalid');
                }
            });

            if (!isBrowserValid) return;

            // Check uniqueness when moving from step 1 to 2
            if (currentStep === 1 && step === 2) {
                const isUnique = await checkUniqueness();
                if (!isUnique) return;
            }
        }

        // Hide all steps
        $('[id^="step-"]').hide();
        clearValidationErrors();

        // Show relevant step(s)
        if (step === 3) {
            // Validate step 2 before showing step 3
            const $step2Container = $('#step-2');
            const $inputsStep2 = $step2Container.find('input[required], select[required]');
            let isStep2Valid = true;

            $inputsStep2.each(function() {
                if (!this.checkValidity()) {
                    isStep2Valid = false;
                    return false; // break loop
                }
            });

            if (!isStep2Valid) {
                $('#step-2').show();
                updateStepIndicator(2);
                currentStep = 2;
                return;
            }

            // Show steps 1-3 for confirmation
            $('#step-1, #step-2, #step-3').show();
            $('#step-1 .form-actions, #step-2 .form-actions').hide();

            const surname = $('#surname').val().trim();
            const firstName = $('#first_name').val().trim();
            $('#confirmation-name-paragraph').text(`I, ${surname} ${firstName},`);
        } else {
            $(`#step-${step}`).show();
        }

        updateStepIndicator(step);
        currentStep = step;
    }

    /**
     * Update the step indicator at the top
     * @param {number} activeStep - Current active step number
     */
    function updateStepIndicator(activeStep) {
        for (let i = 1; i <= 4; i++) {
            const $indicator = $(`#step-indicator-${i}`);
            if ($indicator.length === 0) continue;

            const $circle = $indicator.find('.step-circle');
            $indicator.removeClass('completed active');

            if (i < activeStep) {
                $indicator.addClass('completed');
                $circle.html('<i class="fas fa-check"></i>');
            } else if (i === activeStep) {
                $indicator.addClass('active');
                $circle.html(i === 4 ? '<i class="fas fa-flag-checkered"></i>' : i);
            } else {
                $circle.html(i === 4 ? '<i class="fas fa-flag-checkered"></i>' : i);
            }
        }
    }

    // ===================================================================================
    // FILE DOWNLOAD FUNCTION
    // ===================================================================================

    /**
     * Download application number as text file
     */
    function downloadApplicationNumber() {
        const appNumber = $('#application-number').text();

        if (!appNumber) {
            alert('{% trans "Application not found!" %}');
            return;
        }

        const fileContent = `{% trans "Your application number to Diplomat University:" %} ${appNumber}`;
        const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);

        const $link = $('<a>', {
            href: url,
            download: `${appNumber}.txt`
        }).hide().appendTo('body');

        $link[0].click();
        setTimeout(function() {
            $link.remove();
            URL.revokeObjectURL(url);
        }, 100);
    }

    // ===================================================================================
    // DOCUMENT READY HANDLER
    // ===================================================================================

    $(document).ready(function() {
        // Load saved form data
        loadFormState();

        const $form = $('#applicationForm');
        const $submitBtn = $('#submit-btn');

        // Save form state on input changes
        $form.on('input', saveFormState);

        // Related select event listeners
        $('#degree').on('change', function() {
            loadDirections(this.value);
        });

        $('#education-direction').on('change', function() {
            loadStudyForms(this.value);
        });

        // JSHIR input - numbers only
        $('#jshir').on('input', function() {
            $(this).val($(this).val().replace(/[^0-9]/g, ''));
        });

        // Confirmation checkbox logic
        $('#confirm-checkbox').on('change', function() {
            $submitBtn.prop('disabled', !this.checked);
        });

        // Form submission
        $form.on('submit', function(event) {
            event.preventDefault();

            if (!$('#confirm-checkbox').is(':checked')) {
                alert('{% trans "Please confirm the application." %}');
                return;
            }

            const formData = new FormData(this);
            $submitBtn.prop('disabled', true).text('{% trans "Sending..." %}');

            $.ajax({
                url: $form.attr('action') || window.location.pathname,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
                },
                success: function(result) {
                    if (result.success) {
                        $('#application-number').text(result.application_number);
                        goToStep(4);
                        localStorage.removeItem('applicationFormData');
                    } else {
                        alert('{% trans "There was an error submitting the application. Please check the fields." %}');
                        console.error('Server errors:', result.errors);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Submit error:', error);
                    alert('{% trans "An unexpected error occurred while submitting the application." %}');
                },
                complete: function() {
                    $submitBtn.prop('disabled', false).text('SUBMIT');
                }
            });
        });

        // Save application number button
        $('#save-app-number-btn').on('click', downloadApplicationNumber);

        // Initialize step indicator
        updateStepIndicator(1);
    });
    </script>
<script>
$(document).ready(function() {
    $('#checkStatusForm').submit(function(e) {
        e.preventDefault();

        // Clear previous results
        $('#statusResult').empty();

        const appNumber = $('#applicationNumber').val().trim();
        if (!appNumber) {
            $('#statusResult').html('<div class="alert alert-danger">{% trans "Application number" %}</div>');
            return;
        }

        // Show loading state
        $.ajax({
            url: '{% url "check_application_status" %}',
            type: 'POST',
            data: {
                'application_number': appNumber,
                'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
            },
            success: function(response) {
                if (response.success) {
                    const statusClass = 'status-' + response.status.toLowerCase();
                    const statusDisplay = response.status_display;

                    $('#statusResult').html(`
                        <div class="${statusClass}">
                            <strong>{% trans "Status" %}:</strong> ${statusDisplay}
                        </div>
                    `);
                } else {
                    $('#statusResult').html(`<div class="alert alert-danger">${response.error}</div>`);
                }
            },
            error: function(xhr) {
                let errorMsg = "{% trans 'Server error. Please try again later.' %}";
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                }
                $('#statusResult').html(`<div class="alert alert-danger">${errorMsg}</div>`);
            },
            complete: function() {
                $('.check-btn').prop('disabled', false).val('{% trans "Check" %}');
            }
        });
    });
});
</script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>